#!/usr/bin/env node

import { readFileSync, writeFileSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const TEMPLATES_DIR = join(__dirname, "../templates");
const OUTPUT_FILE = join(__dirname, "../src/templates.ts");

const templateFiles = [
  "security.md",
  "unit-tests.md",
  "naming.md",
  "architecture.md",
  "performance.md",
  "code-review.md",
  "error-handling.md",
  "documentation.md",
  "accessibility.md",
  "api-design.md",
  "git-workflow.md",
];

// Read rules.json for metadata
const rulesMetadata = JSON.parse(
  readFileSync(join(TEMPLATES_DIR, "rules.json"), "utf-8"),
);

// Generate TypeScript file
let output = `// This file is auto-generated by scripts/generate-templates.js
// Do not edit manually! Edit the markdown files in templates/ instead.

// ============================================================================
// TYPE DEFINITIONS
// ============================================================================

export interface ManifestOptions {
  dir: string;
  minimal: boolean;
  filename?: string;
}

export interface RuleDefinition {
  id: string;
  filename: string;
  minimal: boolean;
  modes: string[];
}

export interface RuleTemplate {
  filename: string;
  content: string;
}

// ============================================================================
// EMBEDDED TEMPLATES
// ============================================================================

`;

// Add each template as a constant
for (const filename of templateFiles) {
  const content = readFileSync(join(TEMPLATES_DIR, filename), "utf-8");
  const varName = filename.replace(".md", "").replace(/-/g, "_") + "_md";
  output += `const ${varName} = ${JSON.stringify(content)};\n\n`;
}

// Create template map
output += `const TEMPLATES: Record<string, string> = {\n`;
for (const filename of templateFiles) {
  const varName = filename.replace(".md", "").replace(/-/g, "_") + "_md";
  output += `  '${filename}': ${varName},\n`;
}
output += `};\n\n`;

// Add rule definitions from rules.json
output += `// ============================================================================
// RULE DEFINITIONS
// ============================================================================

const RULE_DEFINITIONS: RuleDefinition[] = ${JSON.stringify(rulesMetadata.rules, null, 2)};

// ============================================================================
// TEMPLATE LOADING
// ============================================================================

function loadTemplate(filename: string): string {
  const template = TEMPLATES[filename];
  if (!template) {
    throw new Error(\`Template not found: \${filename}\`);
  }
  return template;
}

// ============================================================================
// PUBLIC API
// ============================================================================

function detectManifestFormat(filename: string): 'json' | 'yaml' {
  return filename.endsWith('.json') ? 'json' : 'yaml';
}

export function generateManifest(options: ManifestOptions): string {
  const { dir, minimal, filename } = options;
  const format = filename ? detectManifestFormat(filename) : 'json';
  
  // Filter rules based on minimal flag
  const activeRules = RULE_DEFINITIONS.filter(rule => 
    minimal ? rule.minimal : true
  );
  
  // Generate rules section
  const rules = activeRules
    .map(rule => \`  \${rule.id}: "\${dir}/\${rule.filename}"\`)
    .join('\\n');
  
  // Generate order section
  const order = activeRules
    .map(rule => \`  - \${rule.id}\`)
    .join('\\n');
  
  // Generate modes section
  const modeNames = ['codegen', 'review', 'test', 'docs', 'ops'];
  const modesSection = modeNames
    .map(modeName => {
      const rulesForMode = activeRules
        .filter(rule => rule.modes.includes(modeName))
        .map(rule => rule.id);
      
      return \`  \${modeName}:\\n    include: [\${rulesForMode.join(', ')}]\`;
    })
    .join('\\n');

  if (format === 'json') {
    const manifest = {
      version: 1,
      about: {
        name: "Repo Vibes",
        description: "How AIs should work in this repo"
      },
      rules: Object.fromEntries(
        activeRules.map(rule => [rule.id, \`\${dir}/\${rule.filename}\`])
      ),
      order: activeRules.map(rule => rule.id),
      modes: Object.fromEntries(
        modeNames.map(modeName => [
          modeName,
          {
            include: activeRules
              .filter(rule => rule.modes.includes(modeName))
              .map(rule => rule.id)
          }
        ])
      )
    };
    return JSON.stringify(manifest, null, 2);
  }

  // YAML format
  return \`version: 1

about:
  name: "Repo Vibes"
  description: "How AIs should work in this repo"

rules:
\${rules}

order:
\${order}

modes:
\${modesSection}
\`;
}

export function getRuleTemplates(minimal: boolean): RuleTemplate[] {
  return RULE_DEFINITIONS
    .filter(rule => minimal ? rule.minimal : true)
    .map(rule => ({
      filename: rule.filename,
      content: loadTemplate(rule.filename),
    }));
}
`;

writeFileSync(OUTPUT_FILE, output);
console.log("âœ“ Generated src/templates.ts from templates/*.md");
